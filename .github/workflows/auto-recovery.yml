name: Auto Recovery Check

on:
  # 자동복구 기능 비활성화됨
  # schedule:
  #   # 매 5분마다 실행
  #   - cron: '*/5 * * * *'
  workflow_dispatch: # 수동 실행 가능

jobs:
  auto-recovery:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check Supabase and Auto Recovery
      run: |
        echo "Starting auto recovery check..."
        
        # Netlify 함수 URL (실제 배포 URL로 변경 필요)
        RECOVERY_URL="${{ secrets.NETLIFY_SITE_URL }}/.netlify/functions/auto-recovery"
        RECOVERY_KEY="${{ secrets.RECOVERY_API_KEY }}"
        
        # 자동 복구 체크 실행
        response=$(curl -s -X GET \
          -H "Content-Type: application/json" \
          -H "x-recovery-key: ${RECOVERY_KEY}" \
          "${RECOVERY_URL}")
        
        echo "Recovery response: $response"
        
        # 응답 파싱하여 결과 확인
        success=$(echo "$response" | jq -r '.success // false')
        supabase_status=$(echo "$response" | jq -r '.supabase_status // "unknown"')
        
        if [ "$success" = "true" ] && [ "$supabase_status" = "active" ]; then
          echo "✅ Supabase is active and recovery check completed successfully"
          
          # 복구 결과 확인
          total_recovered=$(echo "$response" | jq -r '.recovery_result.total_recovered // 0')
          if [ "$total_recovered" -gt 0 ]; then
            echo "🎉 Successfully recovered $total_recovered items"
          else
            echo "ℹ️ No recovery needed - all data is already synced"
          fi
        else
          echo "⚠️ Supabase is still paused or recovery failed"
        fi
        
      env:
        NETLIFY_SITE_URL: ${{ secrets.NETLIFY_SITE_URL }}
        RECOVERY_API_KEY: ${{ secrets.RECOVERY_API_KEY }}
