name: Auto Recovery Check

on:
  # ìë™ë³µêµ¬ ê¸°ëŠ¥ ë¹„í™œì„±í™”ë¨
  # schedule:
  #   # ë§¤ 5ë¶„ë§ˆë‹¤ ì‹¤í–‰
  #   - cron: '*/5 * * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  auto-recovery:
    runs-on: ubuntu-latest
    
    steps:
    - name: Check Supabase and Auto Recovery
      run: |
        echo "Starting auto recovery check..."
        
        # Netlify í•¨ìˆ˜ URL (ì‹¤ì œ ë°°í¬ URLë¡œ ë³€ê²½ í•„ìš”)
        RECOVERY_URL="${{ secrets.NETLIFY_SITE_URL }}/.netlify/functions/auto-recovery"
        RECOVERY_KEY="${{ secrets.RECOVERY_API_KEY }}"
        
        # ìë™ ë³µêµ¬ ì²´í¬ ì‹¤í–‰
        response=$(curl -s -X GET \
          -H "Content-Type: application/json" \
          -H "x-recovery-key: ${RECOVERY_KEY}" \
          "${RECOVERY_URL}")
        
        echo "Recovery response: $response"
        
        # ì‘ë‹µ íŒŒì‹±í•˜ì—¬ ê²°ê³¼ í™•ì¸
        success=$(echo "$response" | jq -r '.success // false')
        supabase_status=$(echo "$response" | jq -r '.supabase_status // "unknown"')
        
        if [ "$success" = "true" ] && [ "$supabase_status" = "active" ]; then
          echo "âœ… Supabase is active and recovery check completed successfully"
          
          # ë³µêµ¬ ê²°ê³¼ í™•ì¸
          total_recovered=$(echo "$response" | jq -r '.recovery_result.total_recovered // 0')
          if [ "$total_recovered" -gt 0 ]; then
            echo "ğŸ‰ Successfully recovered $total_recovered items"
          else
            echo "â„¹ï¸ No recovery needed - all data is already synced"
          fi
        else
          echo "âš ï¸ Supabase is still paused or recovery failed"
        fi
        
      env:
        NETLIFY_SITE_URL: ${{ secrets.NETLIFY_SITE_URL }}
        RECOVERY_API_KEY: ${{ secrets.RECOVERY_API_KEY }}
